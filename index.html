<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JEE Mains — NTA-style Mock Test (Embedded Questions)</title>
<style>
  :root{
    --nta-orange:#f97316;
    --bg:#f3f4f6;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0b63d6;
    --green:#10b981;
    --red:#ef4444;
    --shadow: 0 8px 24px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#111;background:var(--bg);-webkit-font-smoothing:antialiased}
  header{background:linear-gradient(90deg,var(--nta-orange),#ff8a3d);color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:18px;margin:0;font-weight:700}
  .top-info{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.12);padding:7px 10px;border-radius:8px;font-size:14px}
  .container{max-width:1200px;margin:18px auto;padding:12px}
  .exam-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  .left,.right{background:var(--card);padding:14px;border-radius:10px;box-shadow:var(--shadow)}
  .left{min-height:680px;display:flex;flex-direction:column}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{background:#fff;border:1px solid #e6e7ee;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
  .tab.active{background:rgba(255,255,255,0.14);color:#fff;border-color:transparent;box-shadow:inset 0 -2px 0 rgba(255,255,255,0.06)}
  .question-area{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg,#fff,#fafafa);border:1px solid #eef2f7}
  .qmeta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .qno{font-weight:700}
  .qtext{margin-bottom:12px;line-height:1.5}
  .options{display:flex;flex-direction:column;gap:10px}
  .option{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;border:1px solid #eef2f7;cursor:pointer;background:#fff;transition:all .15s}
  .option:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(15,23,42,0.04)}
  .option.selected{border-color:var(--nta-orange);background:linear-gradient(180deg,#fff8f0,#fffefb)}
  .controls{display:flex;justify-content:space-between;gap:10px;margin-top:12px;align-items:center}
  .controls .left-controls{display:flex;gap:8px;flex-wrap:wrap}
  button.btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--nta-orange);color:#fff}
  .btn.ghost{background:#fff;border:1px solid #e6e7ee;color:var(--muted)}
  .btn.warn{background:#fff6ed;border:1px solid #ffd7a6;color:#92400e}
  .small{font-size:13px;color:var(--muted)}
  .right .palette-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px}
  .pal-btn{padding:10px;border-radius:6px;border:1px solid #e6e7ee;background:#fff;cursor:pointer;text-align:center;font-weight:700}
  .pal-btn.notvisited{background:#fff}
  .pal-btn.answered{background:#ecfccb;border-color:#bbf7d0}
  .pal-btn.review{background:#fff7ed;border-color:#ffd1a4}
  .pal-legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .legend-item{display:flex;gap:6px;align-items:center;font-size:13px}
  .legend-box{width:14px;height:14px;border-radius:3px}
  .section-summary{margin-top:12px;font-size:13px;color:var(--muted)}
  .footer-note{font-size:13px;color:var(--muted);text-align:center;margin-top:14px}
  @media(max-width:1050px){.exam-grid{grid-template-columns:1fr}.right{order:2}.left{order:1}header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="44" height="44" viewBox="0 0 24 24" fill="none" style="background:#fff;border-radius:8px;padding:6px">
      <path d="M3 12h18" stroke="#f97316" stroke-width="2" stroke-linecap="round"/>
      <path d="M12 3v18" stroke="#f97316" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <div>
      <h1>JEE Mains — Mock Test (NTA-style)</h1>
      <div style="font-size:13px;opacity:0.95">Full-length mock — 25 Q per subject</div>
    </div>
  </div>

  <div class="top-info">
    <div class="chip">Name: <strong id="candName">Guest</strong></div>
    <div class="chip">Test: <strong id="testTitle">Custom Mock</strong></div>
    <div class="chip">Time Left: <strong id="timer">03:00:00</strong></div>
  </div>
</header>

<div class="container">
  <div class="exam-grid">
    <div class="left">
      <div class="topbar">
        <div class="tabs" id="sectionTabs"></div>
        <div class="small">Question <span id="qIndex">1</span>/<span id="qTotal">75</span></div>
      </div>

      <div class="question-area" id="questionArea" role="region" aria-live="polite">
        <!-- injected question -->
      </div>

      <div class="controls">
        <div class="left-controls">
          <button class="btn ghost" id="clearBtn">Clear Response</button>
          <button class="btn warn" id="markBtn">Mark for Review & Next</button>
        </div>
        <div>
          <button class="btn ghost" id="prevBtn">Previous</button>
          <button class="btn primary" id="saveNextBtn">Save & Next</button>
          <button class="btn primary" id="submitBtn">Submit</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong>Question Palette</strong></div>
        <div class="small">Auto-save: <strong id="autoSave">ON</strong></div>
      </div>

      <div id="palette" class="palette-grid"></div>

      <div class="pal-legend">
        <div class="legend-item"><div class="legend-box" style="background:#fff;border:1px solid #e6e7ee"></div>Not Visited</div>
        <div class="legend-item"><div class="legend-box" style="background:#ecfccb"></div>Answered</div>
        <div class="legend-item"><div class="legend-box" style="background:#fff7ed"></div>Marked for Review</div>
      </div>

      <div class="section-summary">
        <strong>Sections</strong>
        <ul id="sectionSummary" style="padding-left:18px;margin-top:8px"></ul>
      </div>

      <div class="footer-note">Use the palette to jump to any question. Your answers are saved locally.</div>
    </div>
  </div>
</div>

<script>
/* ===========
   Mock Test App - All three sections converted to MCQ
   =========== */

const config = {
  candidateName: "Guest User",
  testTitle: "Custom Mock — Real JEE Questions (MCQ)",
  totalDurationMin: 180,
  sections: [
    /* ----------------- Mathematics (25 MCQs) ----------------- */
    {
      id: "maths",
      title: "Mathematics",
      questions: [
        {id:"m1", type:"mcq", text:"If f(x) = 2x² − 3x + 5, find f(2).", options:["5","7","9","11"], answer:1},
        {id:"m2", type:"mcq", text:"Solve |x − 4| = 7. The solutions are:", options:["x = 3 or x = 11","x = 11 or x = −3","x = 4 or x = 11","x = −7 or x = 11"], answer:1},
        {id:"m3", type:"mcq", text:"The roots of x² − 5x + 6 = 0 are:", options:["1 and 6","2 and 3","−2 and −3","3 and 5"], answer:1},
        {id:"m4", type:"mcq", text:"The sum of the first 20 natural numbers is:", options:["190","200","210","220"], answer:2},
        {id:"m5", type:"mcq", text:"Evaluate: sin60° × cos30°.", options:["√3/4","3/4","1/2","√3/2"], answer:1},
        {id:"m6", type:"mcq", text:"Find derivative of y = x³ + 5x.", options:["3x² + 5","x³ + 5","3x + 5","3x²"], answer:0},
        {id:"m7", type:"mcq", text:"Find the integral ∫ 2x dx.", options:["x² + C","2x + C","x + C","x²/2 + C"], answer:0},
        {id:"m8", type:"mcq", text:"Area of triangle with base 10 cm and height 6 cm is:", options:["16 cm²","30 cm²","60 cm²","10 cm²"], answer:1},
        {id:"m9", type:"mcq", text:"Equation of line through (1,2) and (3,6) is:", options:["y = 2x","y = x + 1","y = 3x − 1","y = x + 2"], answer:0},
        {id:"m10", type:"mcq", text:"Value of lim_{x→0} (sin x)/x is:", options:["0","1","Undefined","∞"], answer:1},
        {id:"m11", type:"mcq", text:"Solution set of x² − 4x + 3 < 0 is:", options:["x < 1 or x > 3","1 < x < 3","x ≤ 1 or x ≥ 3","No solution"], answer:1},
        {id:"m12", type:"mcq", text:"Sum of series 3 + 3/2 + 3/4 + … (infinite) equals:", options:["3","4","6","9"], answer:2},
        {id:"m13", type:"mcq", text:"Length of hypotenuse of right triangle with legs 6 and 8 is:", options:["8","10","12","√100"], answer:1},
        {id:"m14", type:"mcq", text:"Equation of circle centered at (0,0) with radius 5 is:", options:["x² + y² = 25","x² + y² = 5","x² − y² = 25","(x − 5)² + y² = 25"], answer:0},
        {id:"m15", type:"mcq", text:"If sin A = 3/5 (A in QI), then cos A =:", options:["3/5","4/5","−3/5","−4/5"], answer:1},
        {id:"m16", type:"mcq", text:"Derivative of sin x is:", options:["−cos x","cos x","sin x","−sin x"], answer:1},
        {id:"m17", type:"mcq", text:"Maximum value of y = −x² + 4x + 1 is:", options:["4","5","3","2"], answer:1},
        {id:"m18", type:"mcq", text:"Evaluate determinant |1 2; 3 4| equals:", options:["−2","2","−1","1"], answer:0},
        {id:"m19", type:"mcq", text:"Midpoint of segment joining (2,3) and (4,7) is:", options:["(2,5)","(3,4)","(3,5)","(4,3)"], answer:2},
        {id:"m20", type:"mcq", text:"Volume of sphere of radius 3 is (π is pi):", options:["36π","9π","36π (incorrect units)","36π/3"], answer:0},
        {id:"m21", type:"mcq", text:"Solve e^x = 5. x equals:", options:["ln 5","5","log 5","1/5"], answer:0},
        {id:"m22", type:"mcq", text:"Value of tan45° + cot45° is:", options:["0","1","2","√2"], answer:2},
        {id:"m23", type:"mcq", text:"If A={1,2} and B={3,4}, number of relations from A to B is:", options:["2^4","3^2","4^2","2^3"], answer:0},
        {id:"m24", type:"mcq", text:"Sum of first 6 natural numbers equals:", options:["15","18","21","24"], answer:2},
        {id:"m25", type:"mcq", text:"Geometric mean of 2 and 8 is:", options:["2","4","6","8"], answer:1}
      ]
    },

    /* ----------------- Physics (25 MCQs) ----------------- */
    {
      id: "physics",
      title: "Physics",
      questions: [
        {id:"p1", type:"mcq", text:"A uniformly charged sphere (total charge Q) — electric field at distance r/2 from center is (r is sphere radius):", options:["Q/(4πε0 r²)","Q/(32πε0 r²)","Zero","Q/(8πε0 r²)"], answer:1},
        {id:"p2", type:"mcq", text:"Two charges +Q and −Q separated by 2a. Electric field at a point on perpendicular bisector at distance x is:", options:["(1/4πε0)·(2Qa)/(a²+x²)^{3/2}","(1/4πε0)·(Q)/(a²+x²)","Zero","(1/4πε0)·(Qa)/(a²+x²)"], answer:0},
        {id:"p3", type:"mcq", text:"Projectile fired with speed v at angle θ. Time of flight is:", options:["v sinθ/g","2v cosθ/g","2v sinθ/g","v/(g sinθ)"], answer:2},
        {id:"p4", type:"mcq", text:"For SHM x = A sin ωt, acceleration at t = π/(2ω) is:", options:["0","−ω²A","ωA","ω²A"], answer:1},
        {id:"p5", type:"mcq", text:"If escape velocity v_e is for a planet, doubling radius (mass same) gives escape velocity:", options:["Same","v_e/2","v_e/√2","2 v_e"], answer:2},
        {id:"p6", type:"mcq", text:"Magnetic force on charged particle at 60° to B is:", options:["qvB","qvB sin60°","qvB cos60°","0"], answer:1},
        {id:"p7", type:"mcq", text:"Two resistors R1=4Ω and R2=6Ω in parallel: equivalent resistance is:", options:["2.4 Ω","10 Ω","0.67 Ω","5 Ω"], answer:0},
        {id:"p8', type:'mcq', text:'Electric potential inside uniformly charged solid sphere (as function of r) varies as:', options:['∝1/r','∝r','∝r²','Constant'], answer:1},
        {id:"p9", type:"mcq", text:"Conducting sphere radius 10 cm with charge 5 µC. Potential at surface (approx) is:", options:["4500 V","500 V","45000 V","45 V"], answer:0},
        {id:"p10", type:"mcq", text:"Time period of simple pendulum is independent of:", options:["Length","Mass","Amplitude (small)","Gravity"], answer:1},
        {id:"p11", type:"mcq", text:"Damping force in damped harmonic motion x = A e^{-γt} cos ωt is proportional to:", options:["Displacement x","Velocity dx/dt","Acceleration d²x/dt²","x²"], answer:1},
        {id:"p12", type:"mcq", text:"Terminal velocity of a sphere falling in viscous fluid ∝ :", options:["1/r","r","r²","constant"], answer:2},
        {id:"p13', type:'mcq', text:'Force between two parallel current-carrying wires is attractive if:', options:['Currents same direction','Currents opposite','Currents zero','Currents equal magnitude but opposite rotates'], answer:0},
        {id:"p14', type:'mcq', text:'Energy stored in capacitor C connected to battery V is:', options:['CV','½ C V²','C V²','2 C V²'], answer:1},
        {id:"p15", type:"mcq", text:"Magnetic field at center of circular loop of radius R carrying current I is:", options:["μ0 I / (2R)","μ0 I / R","μ0 I / (4R)","μ0 I R"], answer:0},
        {id:"p16", type:"mcq", text:"Proton and α-particle have same kinetic energy. Ratio of de Broglie wavelengths (λ_proton : λ_alpha) is:", options:["1:2","2:1","1:1","√2:1"], answer:1},
        {id:"p17", type:"mcq", text:"Capacitance of parallel plate capacitor depends on:", options:["Plate area only","Separation only","Both plate area and separation","Neither"], answer:2},
        {id:"p18", type:"mcq", text:"RMS speed of gas molecules at temperature T ∝ :", options:["T","1/√T","√T","1/T"], answer:2},
        {id:"p19", type:"mcq", text:"Work done by ideal gas during isothermal expansion from Vi to Vf is:", options:["n R T (Vf − Vi)","n R T ln(Vf/Vi)","½ n R T","n C_v (Vf − Vi)"], answer:1},
        {id:"p20", type:"mcq", text:"Wire length L resistance R cut into two equal parts and connected in parallel: equivalent resistance:", options:["R/2","R/4","R","2R"], answer:1},
        {id:"p21", type:"mcq', text:'For displacement x = 5t² − 3t + 2, acceleration at t = 2 s is:', options:['7 m/s²','11 m/s²','20 m/s²','17 m/s²'], answer:2},
        {id:"p22", type:"mcq", text:"Pressure inside liquid at depth h is:", options:["ρgh","gh/ρ","ρg/h","ρ/g"], answer:0},
        {id:"p23", type:"mcq", text:"Wave y = A sin(kx − ωt). Speed of wave is:", options:["ω k","k/ω","ω/k","A ω"], answer:2},
        {id:"p24", type:"mcq", text:"Temperature coefficient of resistivity for most metals is:", options:["Negative","Zero","Positive","Infinite"], answer:2},
        {id:"p25", type:"mcq", text:"Magnetic moment of a current loop is proportional to:", options:["Current only","Area only","Current × Area","Perimeter"], answer:2}
      ]
    },

    /* ----------------- Chemistry (25 MCQs) ----------------- */
    {
      id: "chemistry",
      title: "Chemistry",
      questions: [
        {id:"c1", type:"mcq", text:"Arrange in increasing acidic strength: H2O, HF, HCl, HClO4. Which is correct?", options:["HClO4 < HCl < HF < H2O","H2O < HF < HCl < HClO4","HF < H2O < HCl < HClO4","HCl < HClO4 < HF < H2O"], answer:1},
        {id:"c2", type:"mcq", text:"Major product when CH3CH2Br reacts with Mg (dry ether):", options:["CH3CH2MgBr (Grignard)","CH3CH2OH","CH3CH2Mg","CH3CH2Br remains"], answer:0},
        {id:"c3", type:"mcq", text:"Molecular shape of NH3 is:", options:["Trigonal planar","Tetrahedral","Trigonal pyramidal","Linear"], answer:2},
        {id:"c4", type:"mcq", text:"Element with highest first ionization energy among choices is:", options:["Oxygen","Neon","Sodium","Fluorine"], answer:1},
        {id:"c5", type:"mcq", text:"Moles of O2 required to burn 1 mole C2H6 completely:", options:["2 moles","3 moles","3.5 moles","4 moles"], answer:2},
        {id:"c6", type:"mcq", text:"Hybridization of carbon in ethene (C2H4) is:", options:["sp","sp2","sp3","d2sp3"], answer:1},
        {id:"c7", type:"mcq", text:"Highest boiling point among Methane, Ethane, Ethanol, Water:", options:["Methane","Ethane","Ethanol","Water"], answer:3},
        {id:"c8", type:"mcq", text:"Catalyst used in Haber process is:", options:["Nickel","Platinum","Iron","Copper"], answer:2},
        {id:"c9", type:"mcq", text:"pH of 0.001 M HCl is approximately:", options:["1","2","3","4"], answer:2},
        {id:"c10", type:"mcq", text:"Which is a strong acid?", options:["Acetic acid","HCl","HF","NH3"], answer:1},
        {id:"c11", type:"mcq", text:"Name of compound C2H5OH is:", options:["Dimethyl ether","Ethanol","Ethanal","Methanol"], answer:1},
        {id:"c12", type:"mcq", text:"2SO2 + O2 → 2SO3 is an example of:", options:["Reduction","Oxidation","Both","Neither"], answer:1},
        {id:"c13", type:"mcq", text:"Reaction of Na2CO3 with HCl produces:", options:["H2 gas","CO2 gas","NaClO","No reaction"], answer:1},
        {id:"c14", type:"mcq", text:"Number of electrons in Fe³⁺ is (Fe atomic number 26):", options:["23","24","26","20"], answer:0},
        {id:"c15", type:"mcq", text:"Polymer used for bulletproof jackets:", options:["Nylon","Polyethylene","Kevlar","PVC"], answer:2},
        {id:"c16", type:"mcq", text:"Empirical formula of benzene (C6H6) is:", options:["CH","C2H2","C6H6","C3H3"], answer:0},
        {id:"c17", type:"mcq", text:"Type of bonding in NaCl is:", options:["Covalent","Ionic","Metallic","Hydrogen"], answer:1},
        {id:"c18", type:"mcq", text:"Reaction C2H4 + H2 → C2H6 is called:", options:["Oxidation","Hydrogenation","Hydrolysis","Dehydration"], answer:1},
        {id:"c19", type:"mcq", text:"Valency of chromium in K2Cr2O7 is:", options:["+3","+4","+6","+2"], answer:2},
        {id:"c20", type:"mcq", text:"Product of CH3COOH with PCl5 is:", options:["Acetyl chloride (CH3COCl)","Chloroform","Acetic anhydride","No reaction"], answer:0},
        {id:"c21", type:"mcq", text:"Oxidation state of Mn in KMnO4 is:", options:["+7","+6","+5","+4"], answer:0},
        {id:"c22", type:"mcq", text:"Molarity when 58.5 g NaCl is dissolved in 1 L (Molar mass ≈ 58.5 g/mol):", options:["0.5 M","1 M","2 M","58.5 M"], answer:1},
        {id:"c23", type:"mcq", text:"Number of σ bonds in ethylene (C2H4) is:", options:["3","4","5","6"], answer:2},
        {id:"c24", type:"mcq", text:"IUPAC name of CH3CH2CH2OH is:", options:["1-Propanol","Propan-2-ol","Propanal","Methoxypropane"], answer:0},
        {id:"c25", type:"mcq", text:"Process of solid to vapor without passing through liquid is:", options:["Condensation","Sublimation","Evaporation","Melting"], answer:1}
      ]
    }
  ]
};

/* State and UI logic (unchanged except for loaded questions) */
const state = {
  currentSectionIndex: 0,
  currentQuestionIndex: 0,
  answers: {},
  startTime: null,
  durationSec: config.totalDurationMin * 60,
  timerInterval: null
};

const $ = s => document.querySelector(s);
const formatTime = sec => {
  if(sec<0) sec=0;
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
};

function init(){
  $('#candName').innerText = config.candidateName;
  $('#testTitle').innerText = config.testTitle;
  $('#qTotal').innerText = config.sections.reduce((acc,s)=>acc+s.questions.length,0);
  buildSectionTabs();
  loadState();
  renderQuestion();
  buildPalette();
  updateSectionSummary();
  startTimer();
  $('#saveNextBtn').addEventListener('click', ()=>{ saveAnswer(); gotoNext(); });
  $('#prevBtn').addEventListener('click', ()=>{ saveAnswer(); gotoPrev(); });
  $('#clearBtn').addEventListener('click', clearResponse);
  $('#markBtn').addEventListener('click', ()=>{ markForReviewAndNext(); });
  $('#submitBtn').addEventListener('click', submitPaper);
  window.addEventListener('beforeunload', saveState);
}

function buildSectionTabs(){
  const el = $('#sectionTabs'); el.innerHTML='';
  config.sections.forEach((s,i)=>{
    const b = document.createElement('button');
    b.className = 'tab' + (i===state.currentSectionIndex? ' active':'');
    b.innerText = s.title;
    b.addEventListener('click', ()=>{ state.currentSectionIndex=i; state.currentQuestionIndex=0; updateAfterNavigation(); buildSectionTabs(); });
    el.appendChild(b);
  });
}

function renderQuestion(){
  const sec = config.sections[state.currentSectionIndex];
  const q = sec.questions[state.currentQuestionIndex];
  $('#qIndex').innerText = getGlobalQuestionNumber();
  const area = $('#questionArea'); area.innerHTML='';
  const meta = document.createElement('div'); meta.className='qmeta';
  meta.innerHTML = `<div class="qno">${sec.title} — Q${state.currentQuestionIndex+1}</div><div class="small">Subject: ${sec.title}</div>`;
  const qtext = document.createElement('div'); qtext.className='qtext'; qtext.innerHTML = q.text;
  const opts = document.createElement('div'); opts.className='options';
  if(q.type==='mcq'){
    q.options.forEach((opt, idx)=>{
      const o = document.createElement('div'); o.className='option'; o.tabIndex=0;
      o.innerHTML = `<div style="min-width:28px"><strong>${String.fromCharCode(65+idx)}</strong></div><div style="flex:1">${opt}</div>`;
      o.addEventListener('click', ()=>{ selectOption(q.id, idx); });
      o.addEventListener('keydown', (e)=>{ if(e.key==='Enter') selectOption(q.id, idx); });
      opts.appendChild(o);
    });
  } else {
    const input = document.createElement('input'); input.type='text'; input.placeholder='Numeric answer'; input.style.padding='10px'; input.style.border='1px solid #e6e7ee'; input.style.borderRadius='6px'; input.style.width='100%';
    input.addEventListener('input', ()=>{ state.answers[q.id] = state.answers[q.id]||{}; state.answers[q.id].value = input.value; saveState(); updatePaletteButton(q.id); updateSectionSummary(); });
    opts.appendChild(input);
    const prev = state.answers[q.id] && state.answers[q.id].value; if(prev) input.value = prev;
  }
  area.appendChild(meta); area.appendChild(qtext); area.appendChild(opts);
  reflectSelection(q);
}

function getGlobalQuestionNumber(){
  let n=0;
  for(let i=0;i<state.currentSectionIndex;i++) n+=config.sections[i].questions.length;
  return n + state.currentQuestionIndex + 1;
}

function selectOption(qid, idx){
  state.answers[qid] = state.answers[qid]||{};
  state.answers[qid].value = idx;
  state.answers[qid].marked = false;
  saveState();
  reflectSelectionById(qid);
  updatePaletteButton(qid);
  updateSectionSummary();
}
function reflectSelection(q){
  if(q.type!=='mcq') return;
  const nodes = document.querySelectorAll('.option');
  nodes.forEach((node, idx)=>{
    node.classList.remove('selected');
    const stored = state.answers[q.id] && state.answers[q.id].value;
    if(stored!==undefined && parseInt(stored)===idx) node.classList.add('selected');
  });
}
function reflectSelectionById(qid){
  const sec = config.sections[state.currentSectionIndex];
  const q = sec.questions[state.currentQuestionIndex];
  if(q.id===qid) reflectSelection(q);
}

function gotoNext(){
  const sec=config.sections[state.currentSectionIndex];
  if(state.currentQuestionIndex < sec.questions.length-1){ state.currentQuestionIndex++; renderQuestion(); }
  else if(state.currentSectionIndex < config.sections.length-1){ state.currentSectionIndex++; state.currentQuestionIndex=0; buildSectionTabs(); renderQuestion(); buildPalette(); }
  else{ alert('This is the last question'); }
}
function gotoPrev(){
  if(state.currentQuestionIndex>0){ state.currentQuestionIndex--; renderQuestion(); }
  else if(state.currentSectionIndex>0){ state.currentSectionIndex--; const s=config.sections[state.currentSectionIndex]; state.currentQuestionIndex = s.questions.length-1; buildSectionTabs(); renderQuestion(); buildPalette(); }
  else{ alert('This is the first question'); }
}

function clearResponse(){
  const q = getCurrentQuestion();
  if(!q) return;
  delete state.answers[q.id];
  saveState();
  renderQuestion();
  updatePaletteButton(q.id);
  updateSectionSummary();
}
function markForReviewAndNext(){
  const q = getCurrentQuestion();
  if(!q) return;
  state.answers[q.id] = state.answers[q.id] || {};
  state.answers[q.id].marked = true;
  saveState();
  updatePaletteButton(q.id);
  updateSectionSummary();
  gotoNext();
}
function getCurrentQuestion(){ return config.sections[state.currentSectionIndex].questions[state.currentQuestionIndex]; }

function buildPalette(){
  const sec = config.sections[state.currentSectionIndex];
  const pal = $('#palette'); pal.innerHTML='';
  sec.questions.forEach((q, idx)=>{
    const b = document.createElement('button'); b.className='pal-btn notvisited'; b.id = 'pal-'+q.id; b.innerText = idx+1;
    b.addEventListener('click', ()=>{ state.currentQuestionIndex = idx; renderQuestion(); updatePaletteSelection(idx); });
    pal.appendChild(b);
    updatePaletteButton(q.id);
  });
  updatePaletteSelection(state.currentQuestionIndex);
}
function updatePaletteButton(qid){
  const btn = document.getElementById('pal-'+qid);
  if(!btn) return;
  btn.className='pal-btn';
  const entry = state.answers[qid];
  if(!entry) btn.classList.add('notvisited');
  else if(entry.marked) btn.classList.add('review');
  else if(entry.value!==undefined && entry.value!=='') btn.classList.add('answered');
  else btn.classList.add('notvisited');
}
function updatePaletteSelection(idx){ document.querySelectorAll('.pal-btn').forEach((b,i)=>{ b.style.outline = i===idx? '2px solid rgba(0,0,0,0.08)':'none'; }); }

function updateSectionSummary(){
  const ul = $('#sectionSummary'); ul.innerHTML='';
  config.sections.forEach((s,i)=>{
    const answered = s.questions.filter(q=> state.answers[q.id] && state.answers[q.id].value!==undefined ).length;
    const marked = s.questions.filter(q=> state.answers[q.id] && state.answers[q.id].marked).length;
    const li = document.createElement('li'); li.innerText = `${s.title}: ${answered}/${s.questions.length} answered, ${marked} marked`;
    ul.appendChild(li);
  });
}

function startTimer(){
  if(!state.startTime) state.startTime = Date.now();
  const end = state.startTime + state.durationSec*1000;
  state.timerInterval = setInterval(()=>{
    const left = Math.round((end - Date.now())/1000);
    $('#timer').innerText = formatTime(left);
    if(left<=0){ clearInterval(state.timerInterval); autoSubmit(); }
  },500);
}
function autoSubmit(){ alert('Time is up! Auto-submitting...'); submitPaper(true); }

function saveState(){
  try{
    const payload = {state:{answers: state.answers, startTime: state.startTime, currentSectionIndex: state.currentSectionIndex, currentQuestionIndex: state.currentQuestionIndex}};
    localStorage.setItem('jee_mock_state', JSON.stringify(payload));
    $('#autoSave').innerText='ON';
  } catch(e){ $('#autoSave').innerText='OFF'; }
}
function loadState(){
  try{
    const raw = localStorage.getItem('jee_mock_state'); if(!raw) return;
    const payload = JSON.parse(raw);
    if(payload.state){ state.answers = payload.state.answers || {}; state.startTime = payload.state.startTime || Date.now(); state.currentSectionIndex = payload.state.currentSectionIndex||0; state.currentQuestionIndex = payload.state.currentQuestionIndex||0; }
  } catch(e){ console.warn('No saved state'); }
}

function submitPaper(isAuto=false){
  if(!isAuto){ if(!confirm('Submit test? You will not be able to change answers.')) return; }
  let total=0, attempted=0, correct=0; const details=[];
  config.sections.forEach(sec=>{ sec.questions.forEach(q=>{
    total++; const entry = state.answers[q.id];
    if(entry && entry.value!==undefined && entry.value!=='') attempted++;
    let isCorrect=false;
    if(q.type==='mcq'){
      if(entry && parseInt(entry.value) === q.answer) { correct++; isCorrect=true; }
    } else {
      if(entry && entry.value!==undefined){
        const a=parseFloat(entry.value);
        let b;
        if(typeof q.answer === "string"){
          try { b = eval(q.answer); } catch(e){ b = parseFloat(q.answer); }
        } else b = q.answer;
        if(!isNaN(a) && !isNaN(b) && Math.abs(a-b) <= Math.max(0.01, Math.abs(b)*0.001)) { correct++; isCorrect=true; }
      }
    }
    details.push({id:q.id, text:q.text, your:entry?entry.value:null, correct:isCorrect, solution:q.solution||''});
  })});
  const left=document.querySelector('.left'); left.innerHTML='';
  const res=document.createElement('div'); res.style.padding='14px';
  res.innerHTML=`<h2>Result</h2><p class="small">Total: ${total} | Attempted: ${attempted} | Correct: ${correct} | Score: ${correct} (1 mark each)</p>`;
  const det=document.createElement('details'); det.innerHTML='<summary>Detailed</summary><div></div>'; const wrap=det.querySelector('div');
  details.forEach((d,i)=>{ const e=document.createElement('div'); e.style.borderTop='1px dashed #e6e7ee'; e.style.padding='8px 0'; e.innerHTML=`<div><strong>Q${i+1}:</strong> ${d.text}</div><div class="small">Your: ${d.your===null?'<em>Not answered</em>':d.your} | ${d.correct?'<span style="color:green">Correct</span>':'<span style="color:red">Incorrect</span>'}</div><div class="small">Solution: ${d.solution||'No solution provided'}</div>`; wrap.appendChild(e); });
  res.appendChild(det); left.appendChild(res);
  clearInterval(state.timerInterval);
}

function updateAfterNavigation(){ renderQuestion(); buildPalette(); updateSectionSummary(); saveState(); }
init();
</script>
</body>
</html>
